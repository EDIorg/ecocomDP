<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Create ecocomDP Data • ecocomDP</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Create ecocomDP Data">
<meta property="og:description" content="ecocomDP">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">ecocomDP</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">1.2.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../reference/index.html">Functions</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/create.html">Create</a>
    </li>
    <li>
      <a href="../articles/use.html">Use</a>
    </li>
    <li>
      <a href="../articles/convert.html">Convert</a>
    </li>
    <li>
      <a href="../articles/model_overview.html">Model Overview</a>
    </li>
    <li>
      <a href="../articles/shared_practices_create.html">Shared Practices (Create)</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">News</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/EDIorg/ecocomDP/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="create_files/header-attrs-2.11/header-attrs.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Create ecocomDP Data</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/EDIorg/ecocomDP/blob/master/vignettes/create.Rmd"><code>vignettes/create.Rmd</code></a></small>
      <div class="hidden name"><code>create.Rmd</code></div>

    </div>

    
    
<p>Each ecocomDP dataset (Level-1; L1) is created from a source dataset (Level-0; L0) by a unique processing function. Inputs are typically from the APIs of data repositories and monitoring networks, and outputs can be a list of R objects or a set of archivable files. The output form you choose may depend on multiple factors including the source data license (it may prohibit archive) and the overall processing time (on-demand processing may be prohibitively long). In either case, the derived ecocomDP dataset is delivered to users in a consistent format by <code><a href="../reference/read_data.html">read_data()</a></code> and the processing function provides a fully reproducible and automated routine for updating the derived dataset whenever a new version of the source data are released.</p>
<p>Below is an example function that reads a source dataset from the Environmental Data Initiative (EDI) repository and converts it into an ecocomDP dataset, which in turn is archived in EDI. For an example of creating an ecocomDP dataset on-demand (i.e. not archived), see the map_neon_data_to_ecocomDP.R source code.</p>
<p>Use <code><a href="https://rdrr.io/pkg/ecocomDP/man/view_diagram.html">view_diagram()</a></code> and <code><a href="https://rdrr.io/pkg/ecocomDP/man/view_descriptions.html">view_descriptions()</a></code> for an overview of ecocomDP table relationships and requirements.</p>
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EDIorg/ecocomDP">ecocomDP</a></span><span class="op">)</span></code></pre></div>
<div id="for-archive-in-a-data-repository" class="section level2">
<h2 class="hasAnchor">
<a href="#for-archive-in-a-data-repository" class="anchor"></a>For archive in a data repository</h2>
<div id="example-function" class="section level4">
<h4 class="hasAnchor">
<a href="#example-function" class="anchor"></a>Example function:</h4>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span class="co"># -----------------------------------------------------------------------------</span>
<span class="co"># This function converts source dataset "knb-lter-hfr.118" (archived in the EDI</span>
<span class="co"># Data Repository) to ecocomDP dataset "edi.193" (also archived in EDI)</span>
<span class="co"># </span>
<span class="co"># Arguments:</span>
<span class="co">#</span>
<span class="co"># path        Where the ecocomDP tables will be written</span>
<span class="co"># source_id   Identifier of the source dataset</span>
<span class="co"># derived_id  Identifier of the derived dataset</span>
<span class="co"># url         The URL by which the derived tables and metadata can be accessed </span>
<span class="co">#             by a data repository. This argument is used when automating the </span>
<span class="co">#             repository publication step, but not used when manually </span>
<span class="co">#             publishing.</span>
<span class="co">#</span>
<span class="co"># Value:</span>
<span class="co">#</span>
<span class="co"># tables      (.csv) ecocomDP tables</span>
<span class="co"># metadata    (.xml) EML metadata for tables</span>
<span class="co"># </span>
<span class="co"># Details:</span>
<span class="co">#             This function facilitates automated updates to the derived </span>
<span class="co">#             "edi.193" whenever new data are added to the source </span>
<span class="co">#             "knb-lter-hrf.118". The framework executing this maintenance </span>
<span class="co">#             routine is hosted on a remote server and jumps into action </span>
<span class="co">#             whenever an update notification is received for </span>
<span class="co">#             "knb-lter-hrf.118". The maintenance routine parses the </span>
<span class="co">#             notification to get the arguments to create_ecocomDP().</span>
<span class="co">#</span>
<span class="co"># Landing page to source dataset "knb-lter-hfr.118":</span>
<span class="co"># https://portal.edirepository.org/nis/mapbrowse?scope=knb-lter-hfr&amp;identifier=118</span>
<span class="co"># Landing page to derived dataset "edi.193":</span>
<span class="co"># https://portal.edirepository.org/nis/mapbrowse?scope=edi&amp;identifier=193</span>
<span class="co"># -----------------------------------------------------------------------------</span>

<span class="co"># Libraries used by this function</span>

<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EDIorg/ecocomDP">ecocomDP</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://xml2.r-lib.org/">xml2</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://magrittr.tidyverse.org">magrittr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://r-datatable.com">data.table</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://lubridate.tidyverse.org">lubridate</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://tidyr.tidyverse.org">tidyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://dplyr.tidyverse.org">dplyr</a></span><span class="op">)</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EDIorg/EDIutils">EDIutils</a></span><span class="op">)</span>       <span class="co"># remotes::install_github("EDIorg/EDIutils")</span>
<span class="kw"><a href="https://rdrr.io/r/base/library.html">library</a></span><span class="op">(</span><span class="va"><a href="https://github.com/EDIorg/taxonomyCleanr">taxonomyCleanr</a></span><span class="op">)</span> <span class="co"># remotes::install_github("EDIorg/taxonomyCleanr")</span>

<span class="va">create_ecocomDP</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">path</span>,
                            <span class="va">source_id</span>, 
                            <span class="va">derived_id</span>, 
                            <span class="va">url</span> <span class="op">=</span> <span class="cn">NULL</span><span class="op">)</span> <span class="op">{</span>
  
  <span class="co"># Read source dataset -------------------------------------------------------</span>
  
  <span class="co"># The source dataset is about ant communities and their functional traits </span>
  <span class="co"># changing in response to an invasive species. Observations are made across </span>
  <span class="co"># habitat types within the Harvard Experimental Forest. The dataset consists </span>
  <span class="co"># of a primary table listing abundances at sites through time, and an </span>
  <span class="co"># ancillary table listing physical and functional traits of observed species.</span>
  
  <span class="co"># Read the source dataset from EDI</span>
  
  <span class="va">eml</span> <span class="op">&lt;-</span> <span class="fu">EDIutils</span><span class="fu">::</span><span class="fu"><a href="https://ediorg.github.io/EDIutils/reference/api_read_metadata.html">api_read_metadata</a></span><span class="op">(</span><span class="va">source_id</span><span class="op">)</span>
  <span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">EDIutils</span><span class="fu">::</span><span class="fu"><a href="https://ediorg.github.io/EDIutils/reference/read_tables.html">read_tables</a></span><span class="op">(</span>
    eml <span class="op">=</span> <span class="va">eml</span>, 
    strip.white <span class="op">=</span> <span class="cn">TRUE</span>,
    na.strings <span class="op">=</span> <span class="st">""</span>,
    convert.missing.value <span class="op">=</span> <span class="cn">TRUE</span>, 
    add.units <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>
  
  <span class="va">ants</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">`hf118-01-ants.csv`</span>
  <span class="va">traits</span> <span class="op">&lt;-</span> <span class="va">data</span><span class="op">$</span><span class="va">`hf118-02-functional-traits.csv`</span>
  <span class="va">ants</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/ymd.html">ymd</a></span><span class="op">(</span><span class="va">ants</span><span class="op">$</span><span class="va">date</span><span class="op">)</span>
  
  <span class="co"># Join and flatten the source dataset ---------------------------------------</span>
  
  <span class="co"># Joining all source data and relevant metadata into one big flat table </span>
  <span class="co"># simplifies parsing into ecocomDP tables and facilitates referential </span>
  <span class="co"># integrity in the process.</span>
  
  <span class="co"># Remove duplicate data from the ancillary table and join on species "code"</span>
  
  <span class="va">traits</span> <span class="op">&lt;-</span> <span class="va">traits</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">genus</span>, <span class="op">-</span><span class="va">species</span><span class="op">)</span>
  <span class="va">traits</span> <span class="op">&lt;-</span> <span class="va">traits</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>code <span class="op">=</span> <span class="va">species.code</span><span class="op">)</span>
  <span class="va">wide</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">ants</span>, <span class="va">traits</span>, by <span class="op">=</span> <span class="st">"code"</span><span class="op">)</span>
  
  <span class="co"># Convert wide format to "flat" format. This is the wide form but gathered on </span>
  <span class="co"># core observation variables, which are often &gt; 1 in source datasets. This </span>
  <span class="co"># "flat" table is the "widest" ecocomDP datasets can be consistently returned </span>
  <span class="co"># to by the ecocomDP::flatten_data() function, and is the input format </span>
  <span class="co"># required by the "create table" helpers we'll meet shortly. This dataset </span>
  <span class="co"># only has one core observation variable, "abundance", so gathering really </span>
  <span class="co"># only entails a change of column names.</span>
  
  <span class="va">wide</span> <span class="op">&lt;-</span> <span class="va">wide</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>value_abundance <span class="op">=</span> <span class="va">abundance</span><span class="op">)</span>
  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span>
    <span class="va">wide</span>,
    cols <span class="op">=</span> <span class="fu"><a href="https://tidyselect.r-lib.org/reference/starts_with.html">matches</a></span><span class="op">(</span><span class="st">"abundance"</span><span class="op">)</span>, 
    names_to <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">".value"</span>, <span class="st">"variable_name"</span><span class="op">)</span>, 
    names_sep <span class="op">=</span> <span class="st">'\\_'</span><span class="op">)</span>
  
  <span class="co"># We're now in a good place to begin adding columns of the ecocomDP tables </span>
  <span class="co"># we can create from this source dataset. We'll begin with the observation </span>
  <span class="co"># table.</span>
  
  <span class="co"># Add columns for the observation table -------------------------------------</span>
  
  <span class="co"># The frequency and timing of surveys (events) varied throughout the history </span>
  <span class="co"># of this dataset and are uniquely identifiable by grouping sample dates by </span>
  <span class="co"># year and month.</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">event_id</span> <span class="op">&lt;-</span> <span class="va">flat</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span>month <span class="op">=</span> <span class="fu"><a href="https://lubridate.tidyverse.org/reference/round_date.html">floor_date</a></span><span class="op">(</span><span class="va">flat</span><span class="op">$</span><span class="va">date</span>, <span class="st">"month"</span><span class="op">)</span>,
                                     <span class="va">year</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_indices</a></span><span class="op">(</span><span class="op">)</span>
  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="va">flat</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="va">event_id</span><span class="op">)</span>
  
  <span class="co"># Observations are made in plots, which are nested in blocks. Unique </span>
  <span class="co"># combinations of these form a location</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">location_id</span> <span class="op">&lt;-</span> <span class="va">flat</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">plot</span>, <span class="va">block</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_indices</a></span><span class="op">(</span><span class="op">)</span>
  
  <span class="co"># Each row of the flattened source dataset represents an observation of taxa </span>
  <span class="co"># abundance and should have a unique ID for reference</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">observation_id</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/nrow.html">nrow</a></span><span class="op">(</span><span class="va">flat</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Add columns for the location table ----------------------------------------</span>
  
  <span class="co"># Ideally, the source dataset would include latitude, longitude, and </span>
  <span class="co"># elevation for each location_id, but all we have are coordinates for the </span>
  <span class="co"># area encompassing all sampling locations. The best we can do here is use </span>
  <span class="co"># the middle of the bounding box and mean of the bounding elevations.</span>
  
  <span class="va">geocov</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">eml</span>, <span class="st">".//geographicCoverage"</span><span class="op">)</span>
  <span class="va">north</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_double</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">geocov</span>, <span class="st">'.//northBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">east</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_double</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">geocov</span>, <span class="st">'.//eastBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">south</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_double</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">geocov</span>, <span class="st">'.//southBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">west</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_double</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">geocov</span>, <span class="st">'.//westBoundingCoordinate'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">elev_max</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_double</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">geocov</span>, <span class="st">'.//altitudeMaximum'</span><span class="op">)</span><span class="op">)</span>
  <span class="va">elev_min</span> <span class="op">&lt;-</span> <span class="fu"><a href="http://xml2.r-lib.org/reference/xml_text.html">xml_double</a></span><span class="op">(</span><span class="fu"><a href="http://xml2.r-lib.org/reference/xml_find_all.html">xml_find_all</a></span><span class="op">(</span><span class="va">geocov</span>, <span class="st">'.//altitudeMinimum'</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">latitude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">north</span>, <span class="va">south</span><span class="op">)</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">longitude</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">east</span>, <span class="va">west</span><span class="op">)</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">elevation</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">elev_max</span>, <span class="va">elev_min</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Add columns for the taxon table -------------------------------------------</span>
  
  <span class="co"># Taxonomic entities of this dataset are comprised of unique genus and </span>
  <span class="co"># species pairs</span>
  
  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="va">flat</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>taxon_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/trimws.html">trimws</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste</a></span><span class="op">(</span><span class="va">genus</span>, <span class="va">species</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">%&gt;%</span> 
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="op">-</span><span class="va">genus</span>, <span class="op">-</span><span class="va">species</span><span class="op">)</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">taxon_id</span> <span class="op">&lt;-</span> <span class="va">flat</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">taxon_name</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_data.html">group_indices</a></span><span class="op">(</span><span class="op">)</span>
  
  <span class="co"># While not required, resolving taxonomic entities to an authority system </span>
  <span class="co"># improves the discoverability and interoperability of the ecocomDP dataset. </span>
  <span class="co"># We can resolve taxa by sending names through taxonomyCleanr for direct </span>
  <span class="co"># matches against the Integrated Taxonomic Information System </span>
  <span class="co"># (ITIS; https://www.itis.gov/).</span>
  
  <span class="va">taxa_resolved</span> <span class="op">&lt;-</span> <span class="fu">taxonomyCleanr</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/taxonomyCleanr/man/resolve_sci_taxa.html">resolve_sci_taxa</a></span><span class="op">(</span>
    x <span class="op">=</span> <span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">flat</span><span class="op">$</span><span class="va">taxon_name</span><span class="op">)</span>,
    data.sources <span class="op">=</span> <span class="fl">3</span><span class="op">)</span>
  
  <span class="va">taxa_resolved</span> <span class="op">&lt;-</span> <span class="va">taxa_resolved</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">taxa</span>, <span class="va">rank</span>, <span class="va">authority</span>, <span class="va">authority_id</span><span class="op">)</span> <span class="op">%&gt;%</span>
    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>taxon_rank <span class="op">=</span> <span class="va">rank</span>,
           taxon_name <span class="op">=</span> <span class="va">taxa</span>,
           authority_system <span class="op">=</span> <span class="va">authority</span>,
           authority_taxon_id <span class="op">=</span> <span class="va">authority_id</span><span class="op">)</span>
  
  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">flat</span>, <span class="va">taxa_resolved</span>, by <span class="op">=</span> <span class="st">"taxon_name"</span><span class="op">)</span>
  
  <span class="co"># Add columns for the dataset_summary table ---------------------------------</span>
  
  <span class="va">dates</span> <span class="op">&lt;-</span> <span class="va">flat</span><span class="op">$</span><span class="va">date</span> <span class="op">%&gt;%</span> <span class="fu">stats</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/r/stats/na.fail.html">na.omit</a></span><span class="op">(</span><span class="op">)</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/sort.html">sort</a></span><span class="op">(</span><span class="op">)</span>
  
  <span class="co"># Use the calc_*() helper functions for consistency</span>
  
  <span class="va">flat</span><span class="op">$</span><span class="va">package_id</span> <span class="op">&lt;-</span> <span class="va">derived_id</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">original_package_id</span> <span class="op">&lt;-</span> <span class="va">source_id</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">length_of_survey_years</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_length_of_survey_years.html">calc_length_of_survey_years</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">number_of_years_sampled</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_number_of_years_sampled.html">calc_number_of_years_sampled</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">std_dev_interval_betw_years</span> <span class="op">&lt;-</span> 
    <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_std_dev_interval_betw_years.html">calc_std_dev_interval_betw_years</a></span><span class="op">(</span><span class="va">dates</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">max_num_taxa</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/length.html">length</a></span><span class="op">(</span><span class="fu"><a href="https://Rdatatable.gitlab.io/data.table/reference/duplicated.html">unique</a></span><span class="op">(</span><span class="va">flat</span><span class="op">$</span><span class="va">taxon_name</span><span class="op">)</span><span class="op">)</span>
  <span class="va">flat</span><span class="op">$</span><span class="va">geo_extent_bounding_box_m2</span> <span class="op">&lt;-</span> 
    <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/calc_geo_extent_bounding_box_m2.html">calc_geo_extent_bounding_box_m2</a></span><span class="op">(</span><span class="va">west</span>, <span class="va">east</span>, <span class="va">north</span>, <span class="va">south</span><span class="op">)</span>
  
  <span class="co"># Odds and ends -------------------------------------------------------------</span>
  
  <span class="co"># Rename source columns with an ecocomDP equivalent (date to datetime)</span>
  
  <span class="va">flat</span> <span class="op">&lt;-</span> <span class="va">flat</span> <span class="op">%&gt;%</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/rename.html">rename</a></span><span class="op">(</span>datetime <span class="op">=</span> <span class="va">date</span><span class="op">)</span>
  
  <span class="co"># The hard work is done! The flat table contains all the source data and </span>
  <span class="co"># more! We can now use the "create" functions to parse this table into the </span>
  <span class="co"># ecocomDP tables.</span>
  
  <span class="co"># Parse flat into ecocomDP tables -------------------------------------------</span>
  
  <span class="co"># Each ecocomDP table has an associated "create" function. Begin with the </span>
  <span class="co"># core required tables.</span>
  
  <span class="va">observation</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_observation.html">create_observation</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>, 
    observation_id <span class="op">=</span> <span class="st">"observation_id"</span>, 
    event_id <span class="op">=</span> <span class="st">"event_id"</span>, 
    package_id <span class="op">=</span> <span class="st">"package_id"</span>,
    location_id <span class="op">=</span> <span class="st">"location_id"</span>, 
    datetime <span class="op">=</span> <span class="st">"datetime"</span>, 
    taxon_id <span class="op">=</span> <span class="st">"taxon_id"</span>, 
    variable_name <span class="op">=</span> <span class="st">"variable_name"</span>,
    value <span class="op">=</span> <span class="st">"value"</span>,
    unit <span class="op">=</span> <span class="st">"unit"</span><span class="op">)</span>
  
  <span class="va">location</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_location.html">create_location</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>, 
    location_id <span class="op">=</span> <span class="st">"location_id"</span>, 
    location_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"block"</span>, <span class="st">"plot"</span><span class="op">)</span>, 
    latitude <span class="op">=</span> <span class="st">"latitude"</span>, 
    longitude <span class="op">=</span> <span class="st">"longitude"</span>, 
    elevation <span class="op">=</span> <span class="st">"elevation"</span><span class="op">)</span>
  
  <span class="va">taxon</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_taxon.html">create_taxon</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>, 
    taxon_id <span class="op">=</span> <span class="st">"taxon_id"</span>, 
    taxon_rank <span class="op">=</span> <span class="st">"taxon_rank"</span>, 
    taxon_name <span class="op">=</span> <span class="st">"taxon_name"</span>, 
    authority_system <span class="op">=</span> <span class="st">"authority_system"</span>, 
    authority_taxon_id <span class="op">=</span> <span class="st">"authority_taxon_id"</span><span class="op">)</span>
  
  <span class="va">dataset_summary</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_dataset_summary.html">create_dataset_summary</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>, 
    package_id <span class="op">=</span> <span class="st">"package_id"</span>, 
    original_package_id <span class="op">=</span> <span class="st">"original_package_id"</span>, 
    length_of_survey_years <span class="op">=</span> <span class="st">"length_of_survey_years"</span>,
    number_of_years_sampled <span class="op">=</span> <span class="st">"number_of_years_sampled"</span>, 
    std_dev_interval_betw_years <span class="op">=</span> <span class="st">"std_dev_interval_betw_years"</span>, 
    max_num_taxa <span class="op">=</span> <span class="st">"max_num_taxa"</span>, 
    geo_extent_bounding_box_m2 <span class="op">=</span> <span class="st">"geo_extent_bounding_box_m2"</span><span class="op">)</span>
  
  <span class="co"># Create the ancillary ecocomDP tables. These are optional, but should be </span>
  <span class="co"># included if possible.</span>
  
  <span class="va">observation_ancillary</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_observation_ancillary.html">create_observation_ancillary</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    observation_id <span class="op">=</span> <span class="st">"observation_id"</span>, 
    variable_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"trap.type"</span>, <span class="st">"trap.num"</span>, <span class="st">"moose.cage"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="va">location_ancillary</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_location_ancillary.html">create_location_ancillary</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    location_id <span class="op">=</span> <span class="st">"location_id"</span>,
    variable_name <span class="op">=</span> <span class="st">"treatment"</span><span class="op">)</span>
  
  <span class="va">taxon_ancillary</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_taxon_ancillary.html">create_taxon_ancillary</a></span><span class="op">(</span>
    L0_flat <span class="op">=</span> <span class="va">flat</span>,
    taxon_id <span class="op">=</span> <span class="st">"taxon_id"</span>,
    variable_name <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
      <span class="st">"subfamily"</span>, <span class="st">"hl"</span>, <span class="st">"rel"</span>, <span class="st">"rll"</span>, <span class="st">"colony.size"</span>, 
      <span class="st">"feeding.preference"</span>, <span class="st">"nest.substrate"</span>, <span class="st">"primary.habitat"</span>, 
      <span class="st">"secondary.habitat"</span>, <span class="st">"seed.disperser"</span>, <span class="st">"slavemaker.sp"</span>, 
      <span class="st">"behavior"</span>, <span class="st">"biogeographic.affinity"</span>, <span class="st">"source"</span><span class="op">)</span>,
    unit <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"unit_hl"</span>, <span class="st">"unit_rel"</span>, <span class="st">"unit_rll"</span><span class="op">)</span><span class="op">)</span>
  
  <span class="co"># Create the variable_mapping table. This is optional but highly recommended </span>
  <span class="co"># as it provides unambiguous definitions to variables and facilitates </span>
  <span class="co"># integration with other ecocomDP datasets.</span>
  
  <span class="va">variable_mapping</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_variable_mapping.html">create_variable_mapping</a></span><span class="op">(</span>
    observation <span class="op">=</span> <span class="va">observation</span>,
    observation_ancillary <span class="op">=</span> <span class="va">observation_ancillary</span>,
    location_ancillary <span class="op">=</span> <span class="va">location_ancillary</span>, 
    taxon_ancillary <span class="op">=</span> <span class="va">taxon_ancillary</span><span class="op">)</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'abundance'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/individualCount'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'individualCount'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'treatment'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'The Ecosystem Ontology'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://purl.dataone.org/odo/ECSO_00000506'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Manipulative experiment'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'trap.type'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'The Ecosystem Ontology'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://purl.dataone.org/odo/ECSO_00001591'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'type of trap'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'hl'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/measurementType'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'measurementType'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'rel'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/measurementType'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'measurementType'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'rll'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/measurementType'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'measurementType'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'colony.size'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'The Ecosystem Ontology'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://purl.dataone.org/odo/ECSO_00000311'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Population'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'feeding.preference'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/behavior'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'behavior'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'primary.habitat'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'The Ecosystem Ontology'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://purl.dataone.org/odo/ECSO_00002736'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'type of habitat'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'secondary.habitat'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'The Ecosystem Ontology'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://purl.dataone.org/odo/ECSO_00002736'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'type of habitat'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'seed.disperser'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/behavior'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'behavior'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'slavemaker.sp'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/behavior'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'behavior'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'behavior'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://rs.tdwg.org/dwc/terms/behavior'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'behavior'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'biogeographic.affinity'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'The Ecosystem Ontology'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://purl.dataone.org/odo/ECSO_00002736'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'type of habitat'</span>
  
  <span class="va">i</span> <span class="op">&lt;-</span> <span class="va">variable_mapping</span><span class="op">$</span><span class="va">variable_name</span> <span class="op">==</span> <span class="st">'source'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_system</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'Darwin Core'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_id</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'http://purl.org/dc/terms/references'</span>
  <span class="va">variable_mapping</span><span class="op">$</span><span class="va">mapped_label</span><span class="op">[</span><span class="va">i</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="st">'references'</span>
  
  <span class="co"># Write tables to file</span>
  
  <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/write_tables.html">write_tables</a></span><span class="op">(</span>
    path <span class="op">=</span> <span class="va">path</span>, 
    observation <span class="op">=</span> <span class="va">observation</span>, 
    location <span class="op">=</span> <span class="va">location</span>,
    taxon <span class="op">=</span> <span class="va">taxon</span>,
    dataset_summary <span class="op">=</span> <span class="va">dataset_summary</span>, 
    observation_ancillary <span class="op">=</span> <span class="va">observation_ancillary</span>,
    location_ancillary <span class="op">=</span> <span class="va">location_ancillary</span>, 
    taxon_ancillary <span class="op">=</span> <span class="va">taxon_ancillary</span>, 
    variable_mapping <span class="op">=</span> <span class="va">variable_mapping</span><span class="op">)</span>
  
  <span class="co"># Validate tables -----------------------------------------------------------</span>
  
  <span class="co"># Validation checks ensure the derived set of tables comply with the ecocomDP</span>
  <span class="co"># model. Any issues at this point </span>
  <span class="co"># should be addressed in the lines of code above, the tables rewritten, and </span>
  <span class="co"># another round of validation, to be certain the fix worked.</span>
  
  <span class="va">issues</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/validate_data.html">validate_data</a></span><span class="op">(</span>path <span class="op">=</span> <span class="va">path</span><span class="op">)</span>
  
  <span class="co"># Create metadata -----------------------------------------------------------</span>
  
  <span class="co"># Before publishing the derived ecocomDP dataset, we need to describe it. The </span>
  <span class="co"># create_eml() function does this all for us. It knows the structure of the </span>
  <span class="co"># ecocomDP model and applies standardized table descriptions and mixes in </span>
  <span class="co"># important elements of the source dataset metadata for purposes of </span>
  <span class="co"># communication and provenance tracking.</span>
  
  <span class="co"># Convert "dataset level keywords" listed in the source to "dataset level </span>
  <span class="co"># annotations" in the derived. The predicate "is about" is used, which </span>
  <span class="co"># results in an annotation that reads "This dataset is about 'species </span>
  <span class="co"># abundance'", "This dataset is about an ecological 'Community'", etc. All </span>
  <span class="co"># source datasets involving a human induced manipulative experiment, not a </span>
  <span class="co"># natural disturbance/experiment, should include the "Manipulative </span>
  <span class="co"># experiment" annotation below to enable searching on this term.</span>
  
  <span class="va">dataset_annotations</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span>
    `species abundance` <span class="op">=</span> 
      <span class="st">"http://purl.dataone.org/odo/ECSO_00001688"</span>,
    Community <span class="op">=</span> 
      <span class="st">"http://purl.dataone.org/odo/ECSO_00000310"</span>,
    `Manipulative experiment` <span class="op">=</span> 
      <span class="st">"http://purl.dataone.org/odo/ECSO_00000506"</span>,
    `level of ecological disturbance` <span class="op">=</span> 
      <span class="st">"http://purl.dataone.org/odo/ECSO_00002588"</span>,
    `type of ecological disturbance` <span class="op">=</span> 
      <span class="st">"http://purl.dataone.org/odo/ECSO_00002589"</span><span class="op">)</span>
  
  <span class="co"># Add contact information for the author of this script and dataset</span>
  
  <span class="va">additional_contact</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span>
    givenName <span class="op">=</span> <span class="st">'Colin'</span>,
    surName <span class="op">=</span> <span class="st">'Smith'</span>,
    organizationName <span class="op">=</span> <span class="st">'Environmental Data Initiative'</span>,
    electronicMailAddress <span class="op">=</span> <span class="st">'ecocomdp@gmail.com'</span>,
    stringsAsFactors <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>
  
  <span class="co"># Create EML metadata</span>
  
  <span class="va">eml</span> <span class="op">&lt;-</span> <span class="fu">ecocomDP</span><span class="fu">::</span><span class="fu"><a href="../reference/create_eml.html">create_eml</a></span><span class="op">(</span>
    path <span class="op">=</span> <span class="va">path</span>,
    source_id <span class="op">=</span> <span class="va">source_id</span>,
    derived_id <span class="op">=</span> <span class="va">derived_id</span>,
    is_about <span class="op">=</span> <span class="va">dataset_annotations</span>,
    script <span class="op">=</span> <span class="st">"create_ecocomDP.R"</span>,
    script_description <span class="op">=</span> 
      <span class="st">"A function for converting knb-lter-hrf.118 to ecocomDP"</span>,
    contact <span class="op">=</span> <span class="va">additional_contact</span>,
    user_id <span class="op">=</span> <span class="st">'ecocomdp'</span>,
    user_domain <span class="op">=</span> <span class="st">'EDI'</span>,
    basis_of_record <span class="op">=</span> <span class="st">"HumanObservation"</span><span class="op">)</span>
  
<span class="op">}</span></code></pre></div>
</div>
<div id="example-function-call" class="section level4">
<h4 class="hasAnchor">
<a href="#example-function-call" class="anchor"></a>Example function call:</h4>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R">
<span class="co"># Create directory for tables and metadata</span>

<span class="va">mypath</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/tempfile.html">tempdir</a></span><span class="op">(</span><span class="op">)</span>, <span class="st">"/edi_193"</span><span class="op">)</span>
<span class="fu"><a href="https://rdrr.io/r/base/files2.html">dir.create</a></span><span class="op">(</span><span class="va">mypath</span><span class="op">)</span>

<span class="co"># Create ecocomDP dataset "edi.193.5" from source dataset "knb-lter-hfr.118.33"</span>

<span class="fu">create_ecocomDP</span><span class="op">(</span>
  path <span class="op">=</span> <span class="va">mypath</span>, 
  source_id <span class="op">=</span> <span class="st">"knb-lter-hfr.118.33"</span>, 
  derived_id <span class="op">=</span> <span class="st">"edi.193.5"</span><span class="op">)</span>
<span class="co">#&gt; Retrieving EML for data package knb-lter-hfr.118.33</span>
<span class="co">#&gt;  [0%] Downloaded 0 bytes...</span>
<span class="co">#&gt;  [0%] Downloaded 0 bytes...</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; Searching ITIS for "Aphaenogaster picea"</span>
<span class="co">#&gt; Searching ITIS for "Camponotus novaeboracensis"</span>
<span class="co">#&gt; Searching ITIS for "Aphaenogaster fulva"</span>
<span class="co">#&gt; Searching ITIS for "Temnothorax longispinosus"</span>
<span class="co">#&gt; Searching ITIS for "Stenemma impar"</span>
<span class="co">#&gt; Searching ITIS for "Stenemma diecki"</span>
<span class="co">#&gt; Searching ITIS for "Camponotus pennsylvanicus"</span>
<span class="co">#&gt; Searching ITIS for "Lasius americanus"</span>
<span class="co">#&gt; Searching ITIS for "Myrmica punctiventris"</span>
<span class="co">#&gt; Searching ITIS for "Lasius nearcticus"</span>
<span class="co">#&gt; Searching ITIS for "Formica subaenescens"</span>
<span class="co">#&gt; Searching ITIS for "Lasius umbratus"</span>
<span class="co">#&gt; Searching ITIS for "Formica subsericea"</span>
<span class="co">#&gt; Searching ITIS for "Formica aserva"</span>
<span class="co">#&gt; Searching ITIS for "Formica neogagates"</span>
<span class="co">#&gt; Searching ITIS for "Camponotus nearcticus"</span>
<span class="co">#&gt; Searching ITIS for "Ponera pennsylvanica"</span>
<span class="co">#&gt; Searching ITIS for "Stenamma brevicorne"</span>
<span class="co">#&gt; Searching ITIS for "Lasius claviger"</span>
<span class="co">#&gt; Searching ITIS for "Stenamma impar"</span>
<span class="co">#&gt; Searching ITIS for "Temnothorax lognispinosus"</span>
<span class="co">#&gt; Searching ITIS for "Stenamma diecki"</span>
<span class="co">#&gt; Searching ITIS for "Camponotus herculeanus"</span>
<span class="co">#&gt; Searching ITIS for "Lasius speculiventris"</span>
<span class="co">#&gt; Searching ITIS for "Stenamma schmitti"</span>
<span class="co">#&gt; Searching ITIS for "Lasius neoniger"</span>
<span class="co">#&gt; Searching ITIS for "Camponotus pennsylvanica"</span>
<span class="co">#&gt; Searching ITIS for "Tapinoma sessile"</span>
<span class="co">#&gt; Searching ITIS for "Myrmica AF-smi"</span>
<span class="co">#&gt; Searching ITIS for "Formica neorufibarbis"</span>
<span class="co">#&gt; Searching ITIS for "Myrmica incompleta"</span>
<span class="co">#&gt; Searching ITIS for "Formica argentea"</span>
<span class="co">#&gt; Searching ITIS for "Myrmica AF-scu"</span>
<span class="co">#&gt; Searching ITIS for "Formica dolosa"</span>
<span class="co">#&gt; Searching ITIS for "Formica subintegra"</span>
<span class="co">#&gt; Searching ITIS for "Formica incerta"</span>
<span class="co">#&gt; Searching ITIS for "Myrmica nearctica"</span>
<span class="co">#&gt; Searching ITIS for "Formica pergandei"</span>
<span class="co">#&gt; Searching ITIS for "Formica lasioides"</span>
<span class="co">#&gt; Searching ITIS for "Myrmica pinetorum"</span>
<span class="co">#&gt; Searching ITIS for "Leptothorax canadensis"</span>
<span class="co">#&gt; Searching ITIS for "Myrmica detritinodis"</span>
<span class="co">#&gt; Searching ITIS for "Myrmecina americana"</span>
<span class="co">#&gt; Searching ITIS for "Crematogaster lineolata"</span>
<span class="co">#&gt; Searching ITIS for "Lasius interjectus"</span>
<span class="co">#&gt; Searching ITIS for "Camponotus chromaiodes"</span>
<span class="co">#&gt; Searching ITIS for "Formica pallidefulva"</span>
<span class="co">#&gt; Searching ITIS for "Temnothorax ambiguus"</span>
<span class="co">#&gt; Searching ITIS for "Lasius subglaber"</span>
<span class="co">#&gt; Searching ITIS for "Formica rubicunda"</span>
<span class="co">#&gt; Searching ITIS for "Lasius brevicornis"</span>
<span class="co">#&gt; Searching ITIS for "Lasius aphidicolus"</span>
<span class="co">#&gt; Searching ITIS for "Formica integra"</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; Writing tables to file:</span>
<span class="co">#&gt;   observation</span>
<span class="co">#&gt;   location</span>
<span class="co">#&gt;   taxon</span>
<span class="co">#&gt;   dataset_summary</span>
<span class="co">#&gt;   observation_ancillary</span>
<span class="co">#&gt;   location_ancillary</span>
<span class="co">#&gt;   taxon_ancillary</span>
<span class="co">#&gt;   variable_mapping</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; Validating edi_193:</span>
<span class="co">#&gt;   Required tables</span>
<span class="co">#&gt;   Column names</span>
<span class="co">#&gt;   Required columns</span>
<span class="co">#&gt;   Column classes</span>
<span class="co">#&gt;   Datetime formats</span>
<span class="co">#&gt;   Primary keys</span>
<span class="co">#&gt;   Composite keys</span>
<span class="co">#&gt;   Referential integrity</span>
<span class="co">#&gt;   Latitude and longitude format</span>
<span class="co">#&gt;   Latitude and longitude range</span>
<span class="co">#&gt;   Elevation</span>
<span class="co">#&gt;   variable_mapping</span>
<span class="co">#&gt;</span>
<span class="co">#&gt; Creating EML for derived data package (edi.193.5)</span>
<span class="co">#&gt; Reading EML of L0 data package knb-lter-hfr.118.33</span>
<span class="co">#&gt; Creating EML of L1 data package edi.193.5</span>
<span class="co">#&gt; Updating:</span>
<span class="co">#&gt; &lt;eml&gt;</span>
<span class="co">#&gt;   &lt;dataset&gt;</span>
<span class="co">#&gt;     &lt;alternateIdentifier&gt;</span>
<span class="co">#&gt;     &lt;title&gt;</span>
<span class="co">#&gt;     &lt;pubDate&gt;</span>
<span class="co">#&gt;     &lt;keywordSet&gt;</span>
<span class="co">#&gt;     &lt;contact&gt;</span>
<span class="co">#&gt;     &lt;methods&gt;</span>
<span class="co">#&gt;     &lt;dataTable&gt;</span>
<span class="co">#&gt;     &lt;otherEntity&gt;</span>
<span class="co">#&gt;     &lt;annotations&gt;</span>
<span class="co">#&gt; &lt;/eml&gt;</span>
<span class="co">#&gt; Writing EML</span>
<span class="co">#&gt; Validating EML</span>
<span class="co">#&gt;   Validation passed :)</span>
<span class="co">#&gt; Done.</span>

<span class="co"># The working directory contains a valid set of ecocomDP tables and metadata, </span>
<span class="co"># which is ready for upload to EDI (or any other EML based repository)</span>
<span class="fu"><a href="https://rdrr.io/r/base/list.files.html">dir</a></span><span class="op">(</span><span class="va">mypath</span><span class="op">)</span>
<span class="co">#&gt;  [1] "create_ecocomDP.R"        </span>
<span class="co">#&gt;  [2] "dataset_summary.csv"      </span>
<span class="co">#&gt;  [3] "edi.193.5.xml"            </span>
<span class="co">#&gt;  [4] "location.csv"             </span>
<span class="co">#&gt;  [5] "location_ancillary.csv"   </span>
<span class="co">#&gt;  [6] "observation.csv"          </span>
<span class="co">#&gt;  [7] "observation_ancillary.csv"</span>
<span class="co">#&gt;  [8] "taxon.csv"                </span>
<span class="co">#&gt;  [9] "taxon_ancillary.csv"      </span>
<span class="co">#&gt; [10] "variable_mapping.csv"</span></code></pre></div>
</div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Colin Smith, Eric Sokol, Margaret O'Brien.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
